<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¶©ë¶ í˜„ëŒ€ì°¨ ê²€ìƒ‰ì—”ì§„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .filter-group { @apply flex flex-col gap-1; }
        label { @apply text-xs font-bold text-gray-400 uppercase ml-1; }
        select { @apply border border-gray-200 rounded-lg p-3 text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all; }
        th { @apply bg-gray-50 p-3 text-xs font-bold text-gray-500 border-b sticky top-0; }
        td { @apply p-3 text-sm border-b text-gray-700; }
    </style>
</head>
<body class="bg-gray-50 p-4 md:p-10 text-gray-900">
    <div class="max-w-6xl mx-auto">
        <header class="mb-10">
            <h1 class="text-3xl font-black tracking-tight">HYUNDAI <span class="text-blue-600">CHUNGBUK</span></h1>
            <p class="text-gray-400 mt-2 font-medium">ì‹¤ì‹œê°„ íŠ¹ë³„ì¡°ê±´ ì¬ê³  ê²€ìƒ‰ ì‹œìŠ¤í…œ</p>
        </header>

        <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 mb-8">
            <div id="filter-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="filter-group">
                    <label>ì°¨ì¢…ë³„ (Sheet)</label>
                    <select id="main-model" onchange="loadSheetData(this.value)">
                        <option value="">ì°¨ì¢…ì„ ì„ íƒí•˜ì„¸ìš”</option>
                    </select>
                </div>
                </div>
            <div class="mt-8 pt-6 border-t flex justify-end">
                <button onclick="location.reload()" class="text-sm font-bold text-gray-400 hover:text-gray-600 transition">ğŸ”„ ëª¨ë“  í•„í„° ì´ˆê¸°í™”</button>
            </div>
        </div>

        <div class="mb-4 text-sm font-medium">ê²€ìƒ‰ ê²°ê³¼: <span id="res-count" class="text-blue-600">0</span>ëŒ€</div>
        
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="overflow-x-auto max-h-[600px]">
                <table class="w-full text-left border-collapse">
                    <thead><tr id="t-head"></tr></thead>
                    <tbody id="t-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let fullData = {};
        let currentSheet = [];
        // í•„í„°ë§ì— ì‚¬ìš©í•  í•µì‹¬ í•­ëª©ë“¤ (ì—‘ì…€ ì œëª©ì— ë§ì¶° ìë™ ë§¤ì¹­)
        const filterKeys = ['ì—”ì§„', 'íŠ¸ë¦¼', 'ì˜µì…˜', 'ì™¸ì¥ìƒ‰', 'ì¹¼ë¼', 'ìƒ‰ìƒ', 'ì‹œíŠ¸', 'ë‚´ì¥', 'ìƒì‚°ì¼'];

        async function init() {
            const res = await fetch('/api/cars');
            fullData = await res.json();
            const models = Object.keys(fullData);
            const select = document.getElementById('main-model');
            models.forEach(m => select.add(new Option(m, m)));
        }

        function loadSheetData(sheetName) {
            if(!sheetName) return;
            currentSheet = fullData[sheetName];
            createDynamicFilters();
            applyFilters();
        }

        function createDynamicFilters() {
            const grid = document.getElementById('filter-grid');
            // ì°¨ì¢… ì„ íƒ ë°•ìŠ¤ ì™¸ì— ê¸°ì¡´ì— ìƒì„±ëœ í•„í„°ë“¤ ì‚­ì œ
            const existingFilters = grid.querySelectorAll('.dynamic-filter');
            existingFilters.forEach(f => f.remove());

            if(currentSheet.length === 0) return;

            // ì—‘ì…€ ì²« ë²ˆì§¸ ì¤„ì—ì„œ ì œëª©ë“¤ì„ ê°€ì ¸ì™€ì„œ í•„í„° ë°•ìŠ¤ ìƒì„±
            const firstRow = currentSheet[0];
            Object.keys(firstRow).forEach(key => {
                if(filterKeys.some(fk => key.includes(fk))) {
                    const div = document.createElement('div');
                    div.className = 'filter-group dynamic-filter';
                    div.innerHTML = `<label>${key}</label><select id="f-${key}" onchange="applyFilters()"></select>`;
                    grid.appendChild(div);

                    const select = div.querySelector('select');
                    const values = [...new Set(currentSheet.map(item => item[key]))].filter(Boolean).sort();
                    select.add(new Option(`${key} ì„ íƒ`, ""));
                    values.forEach(v => select.add(new Option(v, v)));
                }
            });
        }

        function applyFilters() {
            let filtered = currentSheet;
            const selects = document.querySelectorAll('#filter-grid select');
            
            selects.forEach(sel => {
                if(sel.id === 'main-model' || !sel.value) return;
                const key = sel.id.replace('f-', '');
                filtered = filtered.filter(item => String(item[key]) === sel.value);
            });

            renderTable(filtered);
        }

        function renderTable(data) {
            const head = document.getElementById('t-head');
            const body = document.getElementById('t-body');
            document.getElementById('res-count').innerText = data.length;

            if(data.length === 0) {
                body.innerHTML = '<tr><td colspan="20" class="p-20 text-center text-gray-300 font-medium">ì¡°ê±´ì— ë§ëŠ” ì°¨ëŸ‰ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            const keys = Object.keys(data[0]);
            head.innerHTML = keys.map(k => `<th>${k}</th>`).join('');
            body.innerHTML = data.map(row => `
                <tr class="hover:bg-gray-50 transition-colors">
                    ${keys.map(k => `<td>${row[k] || '-'}</td>`).join('')}
                </tr>
            `).join('');
        }

        init();
    </script>
</body>
</html>
